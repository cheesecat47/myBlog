<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.github.cheesecat47.myBlog.post.model.mapper.PostMapper">

    <!--  getPosts 결과 매핑 -->
    <resultMap id="getPostsResultMap" type="PostDto">
        <result property="postId" column="id"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="title" column="title"/>
        <result property="createdAt" column="created_at"/>
        <result property="hit" column="hit"/>
        <result property="excerpt" column="excerpt"/>
        <result property="numOfComments" column="num_of_comments"/>
        <association property="author" column="author" javaType="AuthorDto">
            <result property="userId" column="id_str"/>
            <result property="nickName" column="name"/>
        </association>
    </resultMap>

    <!--  getPosts 쿼리 -->
    <select id="getPosts" parameterType="GetPostsRequest" resultMap="getPostsResultMap">
        select Post.id,
               Post.category_id,
               Category.name                                                  as category_name,
               Post.title,
               User.id_str,
               User.name,
               DATE_FORMAT(Post.created_at, '%Y-%m-%dT%TZ') as created_at,
               Post.hit,
               ifnull(Post.excerpt, concat(substr(Post.content, 197), '...')) as excerpt, -- 본문이 200자보다 길다면 197자까지 자르고 '...' 붙이기
               (select count(*)
                from Comment c,
                     User u
                where c.post_id = Post.id
                  and u.id = User.id)                                         as num_of_comments
        from myBlog.Post
                 left outer join myBlog.User on Post.user_id = User.id
                 left outer join myBlog.Category on Post.category_id = Category.id
        where Post.deleted_at is null -- 삭제된 글 정보 제외
          <if test="userId != null">
              and myBlog.User.id_str = #{userId}
          </if>
          <if test="categoryName != null">
            and Category.name = #{categoryName}
          </if>
        order by
          <if test="order == 'latest'">
            Post.created_at desc
          </if>
          <if test="order == 'oldest'">
            Post.created_at asc
          </if>
          <if test="order == 'popular'">
            Post.hit desc, Post.created_at desc
          </if>
        limit #{offset}, #{limit};
    </select>

    <!--  getPostByTitle 결과 매핑 -->
    <resultMap id="getPostByTitleResultMap" type="PostDto">
        <result property="postId" column="post_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="title" column="title"/>
        <result property="createdAt" column="post_created_at"/>
        <result property="hit" column="hit"/>
        <result property="excerpt" column="excerpt"/>
        <result property="content" column="content"/>
        <association property="author" column="author" javaType="AuthorDto">
            <result property="userId" column="id_str"/>
            <result property="nickName" column="name"/>
        </association>
        <collection property="comments" column="comments" javaType="List" ofType="CommentDto">
            <result property="commentId" column="comment_id"/>
            <result property="userId" column="comment_user_id"/>
            <result property="content" column="comment_content"/>
            <result property="createdAt" column="comment_created_at"/>
        </collection>
    </resultMap>

    <!--  getPostByTitle 쿼리 -->
    <select id="getPostByTitle" parameterType="String" resultMap="getPostByTitleResultMap">
        select Post.id                                                        as post_id,
               Post.category_id,
               Category.name                                                  as category_name,
               Post.title,
               User.id_str,
               User.name,
               DATE_FORMAT(Post.created_at, '%Y-%m-%dT%TZ')                   as post_created_at,
               Post.hit,
               ifnull(Post.excerpt, concat(substr(Post.content, 197), '...')) as excerpt,
               Post.content                                                   as post_content,
               Comment.id                                                     as comment_id,
               Comment.user_id                                                as comment_user_id,
               Comment.content                                                as comment_content,
               DATE_FORMAT(Comment.created_at, '%Y-%m-%dT%TZ')                as comment_created_at
        from myBlog.Post
                 left outer join myBlog.User on Post.user_id = User.id
                 left outer join myBlog.Category on Post.category_id = Category.id
                 left outer join myBlog.Comment on Comment.post_id = Post.id
        where Post.title = #{postTitle}
          and Post.deleted_at is null
        order by comment_created_at desc;
    </select>

    <sql id="getUserId">
        select User.id
        from User
        where User.id_str = #{userId}
          and User.deleted_at is null
    </sql>

    <sql id="getCategoryId">
        select Category.id
        from Category
        where Category.name = #{categoryName}
        and Category.blog_id = (<include refid="getUserId"/>)
        and Category.deleted_at is null
    </sql>

    <!-- createPost 쿼리 -->
    <insert id="createPost" parameterType="CreatePostRequestDto">
        insert into Post (category_id, user_id, title, excerpt, content)
        values ((<include refid="getCategoryId"/>),(<include refid="getUserId"/>), #{title}, #{excerpt}, #{content});
    </insert>

    <!-- updatePost 쿼리 -->
    <update id="updatePost" parameterType="UpdatePostRequestDto">
        <selectKey keyProperty="postId" resultType="String" order="BEFORE">
            select Post.id
            from Post
            where Post.user_id = (<include refid="getUserId"/>)
            and Post.title = #{postTitle}
            and Post.deleted_at is null
        </selectKey>
        update Post
        <trim prefix="set" suffixOverrides=",">
            <if test="newTitle != null">Post.title = #{newTitle},</if>
            <if test="categoryName != null">Post.category_id = (<include refid="getCategoryId"/>),</if>
            <if test="excerpt != null">Post.excerpt = #{excerpt},</if>
            <if test="content != null">Post.content = #{content},</if>
            Post.updated_at = now(),
        </trim>
        where Post.id = #{postId}
    </update>
</mapper>
